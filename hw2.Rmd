Homework 1 - Team 1
========================================================

### Task 0 - Load the data

```{r}
suppressMessages(library(dplyr))
load("lego_sales.RData")
```

### Task 1 - Tidying the data

Intialize the Data Frame
```{r}
# find top level names
name0 = sales %>% unlist(recursive=FALSE) %>% names() %>% unique()

# identify number of rows based on maxiumum number of each catagory
sum_n = 
    sapply(name0, function(x) 
        sapply(sales, function(y) 
            length(y[[x]]))) %>% 
    colSums()

# identify subcatagory names
cat_name = 
    sapply(name0, function(x)
        sapply(sales, function(y)
            y[[x]] %>% 
            unlist() %>%
            names()) %>%
        unlist() %>% 
        unique()) 

# create list of column names
cat_name = cat_name[!(sapply(cat_name, is.null))]
name = c(name0, unlist(cat_name, use.names = FALSE))
    
# intialize the data frame given the extents discovered above
lego_df = matrix(nrow = max(sum_n), ncol = length(name)) %>%
    data.frame() %>% 
    tbl_df() %>%
    setNames(name)

lego_df['hobbies'] = as.list(lego_df['hobbies'])
```

Create a helper function
```{r}
# A 'safe' rep function that returns NA value when encountering NULL
# Outputs a list if the input is a vector with multiple elements
rep_safe = function(x, t) {
    if (is.null(x) | is.list(x)) {
        rep(NA, t) 
    } else if (length(x) != 1) {
        list(x)[rep(1,t)]
    } else {
        rep(x, t)
    }
}
```

Loop over and fill the data frame
```{r}
name_max = names(which.max(sum_n))
for (n in name0) {
    lego_df[[n]] = 
        sapply(sales, function(x) 
            rep_safe(x[[n]], length(x[[name_max]]))) %>%
        unlist(recursive=FALSE)
    for (c in cat_name[[n]]) {
        lego_df[[c]] =
            sapply(sales, function(x) 
                sapply(x[[n]], function(y) y[[c]]))  %>%
            unlist()
    }
}
```

Some manual tidy-ing
```{r}
is_missing = sapply(lego_df[['hobbies']], function(x) length(x) == 0)
lego_df[['hobbies']][which(is_missing)] = list(NA)
lego_df['purchases'] = NULL
```

## Task 2 - Processing the data

1. What was the most common first name of purchasers? Last name?

```{r}
lego_df %>%
    select(first_name, last_name) %>%
    distinct() %>%
    count(first_name, sort = TRUE) %>%
    .[1,1]

lego_df %>%
    select(first_name, last_name) %>%
    distinct() %>%
    count(last_name, sort = TRUE) %>%
    .[1,1]
```

2. What are the five most popular lego sets based on these data?

```{r}
lego_df %>%
    select(Name, Quantity) %>%
    group_by(Name) %>%
    summarize(Quant_by_name = sum(Quantity)) %>%
    arrange(desc(Quant_by_name)) %>%
    slice(1:5)
```

3. Which five customers have spent the most money so far and how much have they spent?

```{r}
lego_df %>% 
    select(first_name, last_name, USPrice, Quantity) %>%
    mutate(Spent = USPrice * Quantity) %>%
    arrange(desc(Spent)) %>%
    select(first_name, last_name, Spent) %>%
    slice(1:5)
```

4. Which lego theme has made the most money for lego?

```{r}
lego_df %>% 
    select(first_name, last_name, Theme, USPrice, Quantity) %>%
    mutate(Spent = USPrice * Quantity) %>%
    group_by(Theme) %>%
    summarise(Sum_spent = sum(Spent)) %>%
    arrange(desc(Sum_spent)) %>%
    slice(1:5)
```

5. Do men or women buy more lego sets (per person) on average?

```{r}
lego_df %>%
    select(gender, Quantity) %>%
    group_by(gender) %>%
    summarise(mean(Quantity))
```

6. What are the five most popular hobbies of lego purchasers?

```{r}
sapply(sales,function(x){x$hobbies}) %>%
    unlist() %>% 
    table() %>%
    as.data.frame() %>%
    arrange(desc(Freq)) %>%
    slice(1:12)
```

7. How many total pieces have been purchased from lego by these customers?

```{r}
lego_df %>%
    select(Pieces, Quantity) %>%
    transmute(Total_Pieces = Pieces * Quantity) %>%
    summarize(sum(Total_Pieces, na.rm = TRUE))
```

8. What state has spent the most money on legos? Hint - customer area codes may prove useful for this.

```{r}
```
