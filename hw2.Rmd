Homework 1 - Team 1
========================================================

### Task 0 - Load the data

```{r}
suppressMessages(library(dplyr))
load("lego_sales.RData")
```

### Task 1 - Tidying the data

Intialize the Data Frame
```{r}
# find top level names
#unlist make the whole list flatten, unique is to make the duplicable thing go away
name0 = sales %>% unlist(recursive=FALSE) %>% names() %>% unique()

# identify number of rows based on maxiumum number of each catagory
sum_n = 
    sapply(name0, function(x) 
        sapply(sales, function(y) #go 2 level deep
            length(y[[x]]))) %>% # x reference x of name, y is reference for name
    colSums()

# identify subcatagory names
cat_name = 
    sapply(name0, function(x)
        sapply(sales, function(y)
            y[[x]] %>% 
            unlist() %>%
            names()) %>%
        unlist() %>% 
        unique()) 

# create list of column names
cat_name = cat_name[!(sapply(cat_name, is.null))]
name = c(name0, unlist(cat_name, use.names = FALSE))#use.names to remove "purchases"
    
# intialize the data frame given the extents discovered above
lego_df = matrix(nrow = max(sum_n), ncol = length(name)) %>%
    data.frame() %>% 
    tbl_df() %>%
    setNames(name)

# hobbies is a special case
lego_df['hobbies'] = as.list(lego_df['hobbies'])
```

Create a helper function
```{r}
# A 'safe' rep function that returns NA value when encountering NULL
# Outputs a list if the input is a vector with multiple elements
rep_safe = function(x, t) {           #use rep to replicate a person's name
    if (is.null(x) | is.list(x)) {    #if we have a null, it doesn't give us a right result
        rep(NA, t)                    #x is the input, t is the number of times to repeat
    } else if (length(x) != 1) {      #such as hobbies have two things in one column
        list(x)[rep(1,t)]
    } else {
        rep(x, t)
    }
}
```

Loop over and fill the data frame
```{r}
name_max = names(which.max(sum_n))    #which.max give you where is the position of the max number
for (n in name0) {
    lego_df[[n]] = 
        sapply(sales, function(x) 
            rep_safe(x[[n]], length(x[[name_max]]))) %>%
        unlist(recursive=FALSE)
    for (c in cat_name[[n]]) {
        lego_df[[c]] =
            sapply(sales, function(x) 
                sapply(x[[n]], function(y) y[[c]]))  %>% 
            unlist()
    }
}
```

Finally we need to do some manual tidy-ing: 1) in 'hobbies', replace "length = 0"" with "NA"
2) delete the column "purchases" since all the information in the purchases are already in the other columns. 
```{r}
is_missing = sapply(lego_df[['hobbies']], function(x) length(x) == 0)
lego_df[['hobbies']][which(is_missing)] = list(NA)   #which gives the number of each true
lego_df['purchases'] = NULL   #delete the column purchases
```



## Task 2 - Processing the data

1. What was the most common first name of purchasers? Last name?

```{r}
lego_df %>%
    select(first_name, last_name) %>%
    distinct() %>%
    count(first_name, sort = TRUE) %>%
    .[1,1]

lego_df %>%
    select(first_name, last_name) %>%
    distinct() %>%
    count(last_name, sort = TRUE) %>%
    .[1,1]
```

2. What are the five most popular lego sets based on these data?

```{r}
lego_df %>%
    select(Name, Quantity) %>%
    group_by(Name) %>%
    summarize(Quant_by_name = sum(Quantity)) %>%
    arrange(desc(Quant_by_name)) %>%
    slice(1:5)
```

3. Which five customers have spent the most money so far and how much have they spent?

```{r}
lego_df %>% 
    select(first_name, last_name, USPrice, Quantity) %>%
    mutate(Spent = USPrice * Quantity) %>%
    arrange(desc(Spent)) %>%
    select(first_name, last_name, Spent) %>%
    slice(1:5)
```

4. Which lego theme has made the most money for lego?

```{r}
lego_df %>% 
    select(first_name, last_name, Theme, USPrice, Quantity) %>%
    mutate(Spent = USPrice * Quantity) %>%
    group_by(Theme) %>%
    summarise(Sum_spent = sum(Spent)) %>%
    arrange(desc(Sum_spent)) %>%
    slice(1:5)
```

5. Do men or women buy more lego sets (per person) on average?

```{r}
lego_df %>%
    select(gender, Quantity) %>%
    group_by(gender) %>%
    summarise(mean(Quantity))
```

6. What are the five most popular hobbies of lego purchasers?

```{r}
# easy way: using a table 
# All hobbies tied No.4 are considered among the five most popular hobbies.
a = c()
for(i in 1:length(sales)){
  a = c(sales[[i]]$hobbies, a)
}
sort(table(a), decreasing=T)[1:13] 



# using dplyr:



```

7. How many total pieces have been purchased from lego by these customers?

```{r}
lego_df %>%
    select(Pieces, Quantity) %>%
    transmute(Total_Pieces = Pieces * Quantity) %>%
    summarize(sum(Total_Pieces, na.rm = TRUE))
```

8. What state has spent the most money on legos? Hint - customer area codes may prove useful for this.

```{r}
area_code = list(
  Alaska = c(907),
  Alabama = c(205, 251, 256, 334),
  Arkansas = c(479, 501, 870),
  Arizona = c(480, 520, 602, 623, 928),
  California = c(209, 213, 310, 323, 408, 415, 510, 530, 559, 562, 619, 626, 650, 661, 707, 714, 760, 805, 818, 831, 858, 909, 916, 925, 949, 951),
  Colorado = c(303, 719, 970),
  Connecticut = c(203, 860),
  D.C = c(202),
  Delaware = c(302),
  Florida = c(239, 305, 321, 352, 386, 407, 561, 727, 772, 813, 850, 863, 904, 941, 954),
  Georgia = c(229, 404, 478, 706, 770, 912),
  Hawaii = c(808),
  Iowa = c(319, 515, 563, 641, 712),
  Idaho = c(208),
  Illinois = c(217, 309, 312, 618, 630, 708, 773, 815, 847),
  Indiana = c(219, 260, 317, 574, 765, 812),
  Kansas = c(316, 620, 785, 913),
  Kentucky = c(270, 502, 606, 859),
  Louisiana = c(225, 318, 337, 504, 985),
  Massachusetts = c(413, 508, 617, 781, 978),
  Maryland = c(201, 410),
  Maine = c(207),
  Michigan = c(231, 248, 269, 313, 517, 586, 616, 734, 810, 906, 989),
  Minnesota = c(218, 320, 507, 612, 651, 763, 952),
  Missouri = c(314, 417, 573, 636, 660, 816),
  Mississippi = c(228, 601, 662),
  Montana = c(406),
  North_Carolina = c(252, 336, 704, 828, 910, 919),
  North_Dakota = c(701),
  Nebraska = c(308, 402),
  New_Hampshire = c(603),
  New_Jersey = c(201, 609, 732, 856, 908, 973),
  New_Mexico = c(505, 575),
  Nevada = c(702, 775),
  New_York = c(212, 315, 516, 518, 585, 607, 631, 716, 718, 845, 914),
  Ohio = c(216, 330, 419, 440, 513, 614, 740, 937),
  Oklahoma = c(405, 580, 918),
  Oregon = c(503, 541),
  Pennsylvania = c(215, 412, 570, 610, 717, 724, 814),
  Rhode_Island = c(401),
  South_Carolina = c(803, 843, 864),
  South_Dakota = c(605),
  Tennessee = c(423, 615, 731, 865, 901, 931),
  Texas = c(210, 214, 254, 281, 325, 361, 409, 432, 512, 713, 806, 817, 830, 903, 915, 936, 940, 956, 972, 979),
  Utah = c(435, 801),
  Virginia = c(276, 434, 540, 703, 757, 804),
  Vermont = c(802),
  Washington = c(206, 253, 360, 425, 509),
  Wisconsin = c(262, 414, 608, 715, 920),
  West_Virginia = c(304),
  Wyoming = c(307) )





```
